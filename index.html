<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>ğŸ”¥ æ¡Œé¢ IM èŠå¤©å®¤</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body { font-family:"Noto Sans TC",sans-serif; background:#f0f2f5; margin:0; }
#container { display:flex; width:95%; max-width:1200px; margin:20px auto; background:white; border-radius:10px; overflow:hidden; box-shadow:0 3px 8px rgba(0,0,0,0.15); height:600px; }
.sidebar { width:25%; padding:15px; box-sizing:border-box; display:flex; flex-direction:column; background:#f9f9f9; }
.chat-area { flex:1; position:relative; padding:15px; overflow-x:auto; display:flex; align-items:flex-start; }
h3 { margin:5px 0; }
ul { list-style:none; padding:0; margin:0; flex:1; overflow-y:auto; border:1px solid #ddd; border-radius:5px; background:#fff; }
li { padding:8px; cursor:pointer; border-bottom:1px solid #eee; }
li:hover { background:#e6f0ff; }
button { padding:6px; margin:5px 0; border-radius:5px; border:none; cursor:pointer; }
#loginBtn { background:#4285F4; color:white; margin-bottom:10px; }
#logoutBtn { background:#f44336; color:white; float:right; }
.chat-window { width:250px; min-width:250px; max-height:500px; background:#fff; border:1px solid #ddd; border-radius:5px; margin-right:10px; display:flex; flex-direction:column; position:relative; }
.chat-header { background:#4285F4; color:white; padding:5px; border-top-left-radius:5px; border-top-right-radius:5px; display:flex; justify-content:space-between; align-items:center; font-size:14px; }
.chat-messages { flex:1; overflow-y:auto; padding:5px; background:#fafafa; }
.msg { margin:3px 0; padding:4px 6px; border-radius:5px; background:#e6f0ff; font-size:13px; }
.chat-input { display:flex; border-top:1px solid #ddd; }
.chat-input input { flex:1; padding:5px; border:none; outline:none; }
.chat-input button { padding:5px 8px; background:#4CAF50; color:white; border:none; cursor:pointer; }
.rightbar { width:25%; padding:15px; box-sizing:border-box; background:#f9f9f9; display:flex; flex-direction:column; }
</style>
</head>
<body>

<div id="container">
  <!-- å·¦å´å¥½å‹ç¾¤èŠ -->
  <div class="sidebar">
    <button id="loginBtn">ä½¿ç”¨ Google ç™»å…¥</button>
    <button id="logoutBtn" style="display:none;">ç™»å‡º</button>
    <p>ğŸ‘‹ æ­¡è¿ï¼Œ<span id="user"></span></p>
    <h3>å¥½å‹æ¸…å–®</h3>
    <ul id="friendList"></ul>
    <h3>ç¾¤èŠæ¸…å–®</h3>
    <ul id="groupList"></ul>
    <input id="newGroupName" placeholder="ç¾¤èŠåç¨±">
    <button id="createGroupBtn">å»ºç«‹ç¾¤èŠ</button>
  </div>

  <!-- ä¸­é–“èŠå¤©å€ -->
  <div class="chat-area" id="chatArea"></div>

  <!-- å³å´æ–°å¢å¥½å‹ -->
  <div class="rightbar">
    <h3>æ–°å¢å¥½å‹</h3>
    <input id="addFriendEmail" placeholder="è¼¸å…¥ Gmail">
    <button id="addFriendBtn">æ–°å¢å¥½å‹</button>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDwRdQFgQVn5Un8Od2nP4u5EbMx-dMOYoU",
  authDomain: "chat-52c0d.firebaseapp.com",
  projectId: "chat-52c0d",
  storageBucket: "chat-52c0d.firebasestorage.app",
  messagingSenderId: "449329325475",
  appId: "1:449329325475:web:75f255c4055360dc9e6616",
  measurementId: "G-8R8648H53V"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// DOM
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const userSpan = document.getElementById("user");
const friendList = document.getElementById("friendList");
const groupList = document.getElementById("groupList");
const addFriendEmail = document.getElementById("addFriendEmail");
const addFriendBtn = document.getElementById("addFriendBtn");
const createGroupBtn = document.getElementById("createGroupBtn");
const newGroupName = document.getElementById("newGroupName");
const chatArea = document.getElementById("chatArea");

let userEmail = "";
let chatWindows = {}; // å„²å­˜å¤šå€‹èŠå¤©è¦–çª— unsub å‡½æ•¸

loginBtn.onclick = async ()=>{ await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
logoutBtn.onclick = async ()=>{
  await auth.signOut();
  chatWindows={};
  chatArea.innerHTML="";
  friendList.innerHTML="";
  groupList.innerHTML="";
}

auth.onAuthStateChanged(user=>{
  if(user){
    userEmail = user.email;
    userSpan.textContent = `${user.displayName} (${userEmail})`;
    loginBtn.style.display="none";
    logoutBtn.style.display="inline-block";
    loadFriends();
    loadGroups();
  }
});

// è¼‰å…¥å¥½å‹
function loadFriends(){
  db.collection("users").doc(userEmail).collection("friends").onSnapshot(snap=>{
    friendList.innerHTML="";
    snap.forEach(doc=>{
      const li = document.createElement("li");
      li.textContent = doc.data().email;
      li.onclick = ()=>openChatWindow([userEmail,doc.data().email].sort().join("_"), doc.data().email);
      friendList.appendChild(li);
    });
  });
}

// è¼‰å…¥ç¾¤èŠ
function loadGroups(){
  db.collection("groups").onSnapshot(snap=>{
    groupList.innerHTML="";
    snap.forEach(doc=>{
      const li = document.createElement("li");
      li.textContent = doc.id;
      li.onclick = ()=>openChatWindow(doc.id, doc.id);
      groupList.appendChild(li);
    });
  });
}

// æ–°å¢å¥½å‹
addFriendBtn.onclick=async ()=>{
  const email=addFriendEmail.value.trim();
  if(!email)return alert("è«‹è¼¸å…¥å¥½å‹ Gmail");
  await db.collection("users").doc(userEmail).collection("friends").doc(email).set({email});
  addFriendEmail.value="";
}

// å»ºç«‹ç¾¤èŠ
createGroupBtn.onclick=async ()=>{
  const name=newGroupName.value.trim();
  if(!name)return alert("è«‹è¼¸å…¥ç¾¤èŠåç¨±");
  await db.collection("groups").doc(name).set({createdBy:userEmail});
  newGroupName.value="";
}

// é–‹å•ŸèŠå¤©çª—
function openChatWindow(roomId, title){
  if(chatWindows[roomId]) return; // å·²å­˜åœ¨è¦–çª—
  const win = document.createElement("div");
  win.className="chat-window";
  win.id="win_"+roomId;

  const header = document.createElement("div");
  header.className="chat-header";
  header.innerHTML = `<span>${title}</span><button>X</button>`;
  win.appendChild(header);

  const msgDiv = document.createElement("div");
  msgDiv.className="chat-messages";
  win.appendChild(msgDiv);

  const inputDiv = document.createElement("div");
  inputDiv.className="chat-input";
  const input = document.createElement("input");
  input.placeholder="è¼¸å…¥è¨Šæ¯...";
  const btn = document.createElement("button");
  btn.textContent="é€å‡º";
  inputDiv.appendChild(input);
  inputDiv.appendChild(btn);
  win.appendChild(inputDiv);

  chatArea.appendChild(win);

  header.querySelector("button").onclick=()=>{
    if(chatWindows[roomId]) chatWindows[roomId]();
    chatArea.removeChild(win);
    delete chatWindows[roomId];
  }

  // å³æ™‚è¨Šæ¯
  const unsub=db.collection("messages").doc(roomId).collection("chats").orderBy("time")
    .onSnapshot(snap=>{
      msgDiv.innerHTML="";
      snap.forEach(doc=>{
        const d=doc.data();
        const div=document.createElement("div");
        div.className="msg";
        div.textContent=`${d.from}: ${d.text}`;
        msgDiv.appendChild(div);
      });
      msgDiv.scrollTop=msgDiv.scrollHeight;
    });

  chatWindows[roomId]=unsub;

  // é€è¨Šæ¯
  btn.onclick=async ()=>{
    const text=input.value.trim();
    if(!text)return;
    await db.collection("messages").doc(roomId).collection("chats").add({
      from:userEmail,
      text,
      time:firebase.firestore.FieldValue.serverTimestamp()
    });
    input.value="";
  }
}
</script>
</body>
</html>
