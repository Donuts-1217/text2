<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>è¯çµ¡ç°¿ç³»çµ±ï¼ˆå®Œæ•´ç‰ˆï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { font-family: "å¾®è»Ÿæ­£é»‘é«”"; background: #f2f5fa; text-align: center; padding: 20px; }
h1 { color: #2c3e50; }
button { padding:6px 14px; background:#4285F4; color:white; border:none; border-radius:6px; cursor:pointer; margin:2px; font-size:13px; }
button:hover { background:#3367D6; }
textarea, input[type=url], input[type=email], input[type=text] { width:80%; max-width:420px; border-radius:6px; border:1px solid #ccc; padding:6px; margin:4px 0; }
textarea { height:100px; resize:none; }
.note { background:#fff; padding:10px; border-radius:8px; margin-bottom:10px; box-shadow:0 2px 4px rgba(0,0,0,0.1); text-align:left; position:relative; }
.note img { max-width:100%; margin-top:4px; border-radius:4px; cursor:pointer; }
small { color:gray; display:block; margin-top:4px; }
a { color:#4285F4; word-break: break-all; }
.link-div { margin-top:2px; }

/* èŠå¤©å®¤æ¨£å¼ */
#chatWindow { display:none; position:fixed; bottom:80px; right:20px; width:300px; height:0; background:#fff; border:1px solid #ccc; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.2); z-index:999; flex-direction:column; overflow:hidden; transition:height 0.3s ease;}
#chatBox { flex:1; overflow-y:auto; padding:8px;}
#chatBox div{ margin-bottom:4px; display:flex; width:100%; }
.chat-msg{ padding:6px 10px; border-radius:10px; max-width:70%; word-break:break-word; }
.chat-nickname{ font-weight:bold; font-size:14px; margin-bottom:2px; }
.chat-content{ font-size:12px; white-space:pre-wrap; }
.chat-time{ font-size:10px; color:gray; text-align:right; margin-top:2px; }
</style>
</head>
<body>
<h1>ğŸ“˜ è¯çµ¡ç°¿ç³»çµ±</h1>

<div id="login-section">
  <button onclick="googleLogin();">ä½¿ç”¨ Google ç™»å…¥</button>
</div>

<div id="app" style="display:none;">
  <p id="user-info"></p>
  <button onclick="logout()">ç™»å‡º</button>

  <!-- è€å¸«é¢æ¿ -->
  <div id="teacher-panel" style="display:none;">
    <h3>âœï¸ è€å¸«å¯«è¯çµ¡ç°¿</h3>
    <textarea id="note" placeholder="è¼¸å…¥è¯çµ¡ç°¿å…§å®¹..." onkeydown="handleEnter(event)"></textarea><br>
    <input type="url" id="linkInput" placeholder="æ–°å¢è¶…é€£çµ (https://...)"><br>
    <input type="file" id="imageInput" accept="image/*" onchange="previewImage(event)"><br>
    <img id="preview" style="display:none"><br>
    <button onclick="addNote()">é€å‡º</button>
  </div>

  <!-- æœ€é«˜æ¬Šé™é¢æ¿ -->
  <div id="admin-panel" style="display:none;">
    <h3>ğŸ›  æ•™å¸«å¸³è™Ÿç®¡ç†ï¼ˆæœ€é«˜æ¬Šé™ï¼‰</h3>
    <input type="email" id="newTeacherEmail" placeholder="è¼¸å…¥æ•™å¸«Email">
    <button onclick="addTeacher()">æ–°å¢æ•™å¸«</button><br>
    <input type="email" id="deleteTeacherEmail" placeholder="è¼¸å…¥æ•™å¸«Emailåˆªé™¤">
    <button onclick="removeTeacher()">åˆªé™¤æ•™å¸«</button>
  </div>

  <div id="student-panel">
    <h3>ğŸ“– æœ€æ–°è¯çµ¡ç°¿</h3>
    <div id="messages"></div>

    <hr>

    <h3>ğŸ—‘ å›æ”¶ç«™ï¼ˆè€å¸«å¯è¦‹ï¼‰</h3>
    <div id="recycle"></div>
  </div>
</div>

<!-- æµ®å‹•èŠå¤©å®¤æŒ‰éˆ• -->
<button id="chatBtn" style="position:fixed;bottom:20px;right:20px;border-radius:50%;width:50px;height:50px;font-size:24px;z-index:999;">ğŸ’¬</button>

<!-- èŠå¤©å®¤è¦–çª— -->
<div id="chatWindow">
  <div style="padding:6px;background:#4285F4;color:white;border-top-left-radius:8px;border-top-right-radius:8px;display:flex;justify-content:space-between;align-items:center;">
    <span>å­¸ç”ŸèŠå¤©å®¤</span>
    <input id="nicknameInput" type="text" placeholder="æš±ç¨±" style="width:120px;" onblur="saveNickname()">
    <button style="background:#f44336;padding:2px 6px;font-size:12px;" onclick="toggleChat()">X</button>
  </div>
  <div id="chatBox"></div>
  <textarea id="chatInput" placeholder="è¼¸å…¥è¨Šæ¯...(Shift+Enteræ›è¡Œ)" style="resize:none;height:50px;padding:4px;" onkeydown="handleChatEnter(event)"></textarea>
  <button onclick="sendChat()">é€å‡º</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, collection, addDoc, doc, setDoc, query, onSnapshot, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

const firebaseConfig = {apiKey:"AIzaSyAPJ_QfW6IurPiSFg1yrcrr3eu2eoLMXqM",authDomain:"text-585a6.firebaseapp.com",projectId:"text-585a6",storageBucket:"text-585a6.appspot.com",messagingSenderId:"789195223699",appId:"1:789195223699:web:847902083fb646bda25366",measurementId:"G-FL11M47EFP"};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);
const provider = new GoogleAuthProvider();

let role="student"; let isAdmin=false; let nickname = localStorage.getItem('nickname') || 'æˆ‘';

async function googleLogin(){ try{ await signInWithPopup(auth,provider);} catch(e){ alert("ç™»å…¥å¤±æ•—:"+e.message);} }
async function logout(){ await signOut(auth); location.reload(); }
function handleEnter(e){ if(e.key==="Enter"&&!e.shiftKey){ e.preventDefault(); addNote(); } }
function handleChatEnter(e){ if(e.key==="Enter"&&!e.shiftKey){ e.preventDefault(); sendChat(); } }
function previewImage(event){ const preview=document.getElementById("preview"); const file=event.target.files[0]; if(file){ const reader=new FileReader(); reader.onload=e=>{preview.src=e.target.result; preview.style.display="block";}; reader.readAsDataURL(file);} else{preview.src="";preview.style.display="none";} }
function linkify(text){ const urlPattern=/(https?:\/\/[^\s]+)/g; return text.replace(urlPattern,"<a href='$1' target='_blank'>$1</a>"); }

async function addNote(update=false,docId=null,div=null){
  const content=document.getElementById("note").value.trim();
  const link=document.getElementById("linkInput").value.trim()||null;
  const fileInput=document.getElementById("imageInput");
  if(!content && !fileInput.files.length && !link) return alert("è«‹è¼¸å…¥å…§å®¹ã€åœ–ç‰‡æˆ–é€£çµï¼");
  let imageUrl=null;
  if(fileInput.files.length>0){ const file=fileInput.files[0]; const storageRef=ref(storage,`notes/${Date.now()}_${file.name}`); await uploadBytes(storageRef,file); imageUrl=await getDownloadURL(storageRef);}
  if(update && docId && div){
    const text=div.querySelector(".editable").innerText;
    const linksArray=Array.from(div.querySelectorAll(".editable-link")).map(a=>a.innerText);
    await setDoc(doc(db,"notes",docId),{author:div.dataset.author,email:div.dataset.email,content:text,imageUrl:div.dataset.newImage||div.dataset.image||imageUrl||null,links:linksArray,time:new Date().toLocaleString(),deleted:false});
    div.dataset.image=div.dataset.newImage||div.dataset.image||imageUrl||null; div.dataset.newImage="";
  } else { const newLinks=link?[link]:[]; await addDoc(collection(db,"notes"),{author:auth.currentUser.displayName,email:auth.currentUser.email,content:content,imageUrl:imageUrl,links:newLinks,time:new Date().toLocaleString(),deleted:false}); }
  document.getElementById("note").value=""; document.getElementById("linkInput").value=""; fileInput.value=""; document.getElementById("preview").style.display="none";
  maintainLatestFive();
}

async function maintainLatestFive(){
  const snap=await getDocs(collection(db,"notes"));
  const docs=snap.docs.sort((a,b)=>new Date(b.data().time)-new Date(a.data().time));
  for(let i=5;i<docs.length;i++){ const d=docs[i].data(); await setDoc(doc(db,"notes",docs[i].id),{...d,deleted:true}); }
}

async function deleteNote(id){ const d=await getDoc(doc(db,"notes",id)); await setDoc(doc(db,"notes",id),{...d.data(),deleted:true}); }
async function restoreNote(id){ const d=await getDoc(doc(db,"notes",id)); await setDoc(doc(db,"notes",id),{...d.data(),deleted:false}); }

async function addTeacher(){ const email=document.getElementById("newTeacherEmail").value.trim(); if(!email)return alert("è«‹è¼¸å…¥"); await setDoc(doc(db,"users",email),{role:"teacher"}); alert("æ–°å¢å®Œæˆ");}
async function removeTeacher(){ const email=document.getElementById("deleteTeacherEmail").value.trim(); if(!email)return alert("è«‹è¼¸å…¥"); await setDoc(doc(db,"users",email),{role:"student"}); alert("åˆªé™¤å®Œæˆ");}

function saveNickname(){ const val=document.getElementById("nicknameInput").value.trim(); if(val){ nickname=val; localStorage.setItem('nickname',nickname);}}

function toggleChat(){ const win=document.getElementById("chatWindow"); if(win.style.display==="none" || win.style.height==="0px"){ win.style.display="flex"; setTimeout(()=>{ win.style.height="400px"; },10);} else{ win.style.height="0"; setTimeout(()=>{ win.style.display="none"; },300);} }
document.getElementById("chatBtn").addEventListener("click", toggleChat);

async function sendChat(){ const text=document.getElementById("chatInput").value.trim(); if(!text)return; await addDoc(collection(db,"chat"),{author:auth.currentUser.email,nickname:nickname,content:text,time:new Date().toLocaleString(),deleted:false}); document.getElementById("chatInput").value="";}

async function deleteChat(id){ const d=await getDoc(doc(db,"chat",id)); await setDoc(doc(db,"chat",id),{...d.data(),deleted:true});}

function renderNotes(){
  const q=query(collection(db,"notes"));
  onSnapshot(q,snap=>{
    const messagesEl=document.getElementById("messages"); const recycleEl=document.getElementById("recycle");
    messagesEl.innerHTML=""; recycleEl.innerHTML="";
    const docs=snap.docs.sort((a,b)=>new Date(b.data().time)-new Date(a.data().time));
    docs.forEach(docSnap=>{
      const d=docSnap.data(); if(d.deleted && role!=="teacher") return;
      const div=document.createElement("div"); div.className="note"; div.dataset.author=d.author; div.dataset.email=d.email; div.dataset.image=d.imageUrl||""; div.dataset.newImage="";
      div.innerHTML=`<div class="editable" contenteditable="${role==="teacher"}">${linkify(d.content)}</div>
      ${d.imageUrl?`<img src="${d.imageUrl}">`:''}
      ${d.links?d.links.map(l=>`<div class="link-div editable-link" contenteditable="${role==="teacher"}">${l}</div>`).join(''):""}
      <small>${d.time}</small>
      ${role==="teacher"?`<button onclick='deleteNote("${docSnap.id}")'>åˆªé™¤</button>`:""}
      ${role==="teacher" && d.deleted?`<button onclick='restoreNote("${docSnap.id}")'>å¾©åŸ</button>`:""}
      ${role==="teacher"?`<button onclick='addNote(true,"${docSnap.id}",this.parentElement)'>æ›´æ–°</button>`:""}`;
      if(d.deleted) recycleEl.appendChild(div); else messagesEl.appendChild(div);
    });
  });
}

function renderChat(){
  const q=query(collection(db,"chat"));
  onSnapshot(q,snap=>{
    const chatBox=document.getElementById("chatBox"); chatBox.innerHTML="";
    snap.docs.sort((a,b)=>new Date(a.data().time)-new Date(b.data().time)).forEach(docSnap=>{
      const d=docSnap.data(); if(d.deleted && role!=="teacher") return;
      const isMe=d.author===auth.currentUser.email;
      const div=document.createElement("div"); div.style.justifyContent=isMe?"flex-end":"flex-start"; div.style.width="100%";
      div.innerHTML=`<div class="chat-msg" style="background:${isMe?'#4285F4':'#e0e0e0'}; color:${isMe?'white':'black'};">
        <div class="chat-nickname">${d.nickname}</div>
        <div class="chat-content">${d.content.replace(/\n/g,'<br>')}</div>
        <div class="chat-time">${d.time}</div>
        ${role==="teacher"?`<button onclick='deleteChat("${docSnap.id}")' style="font-size:10px;margin-top:2px;">åˆªé™¤</button>`:""}
      </div>`;
      chatBox.appendChild(div); chatBox.scrollTop=chatBox.scrollHeight;
    });
  });
}

onAuthStateChanged(auth,async(user)=>{
  if(user){
    document.getElementById("login-section").style.display="none";
    document.getElementById("app").style.display="block";
    document.getElementById("user-info").innerText=`ğŸ‘‹ æ­¡è¿ ${user.displayName}`;
    const userRef=doc(db,"users",user.email); const userDoc=await getDoc(userRef);
    if(!userDoc.exists()){ await setDoc(userRef,{role:"student"}); } else { role=userDoc.data().role;}
    if(user.email==="chianghansen0302@gmail.com") isAdmin=true;
    if(role==="teacher") document.getElementById("teacher-panel").style.display="block";
    if(isAdmin) document.getElementById("admin-panel").style.display="block";
    nickname = localStorage.getItem('nickname') || user.displayName || 'æˆ‘'; document.getElementById("nicknameInput").value = nickname;
    renderNotes(); renderChat(); maintainLatestFive();
  }
});

window.googleLogin=googleLogin; window.logout=logout; window.addNote=addNote;
window.addTeacher=addTeacher; window.removeTeacher=removeTeacher;
window.deleteNote=deleteNote; window.restoreNote=restoreNote;
window.sendChat=sendChat; window.deleteChat=deleteChat;
window.handleEnter=handleEnter; window.handleChatEnter=handleChatEnter;
window.toggleChat=toggleChat; window.saveNickname=saveNickname;
</script>
</body>
</html>
