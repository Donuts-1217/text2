<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>è¯çµ¡ç°¿ç³»çµ±ï¼ˆæœ€çµ‚ç‰ˆ+èŠå¤©å®¤+å›æ”¶ç«™ï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { font-family:"å¾®è»Ÿæ­£é»‘é«”"; background:#f2f5fa; text-align:center; padding:20px; }
h1 { color:#2c3e50; }
button { padding:6px 14px; background:#4285F4; color:white; border:none; border-radius:6px; cursor:pointer; margin:2px; font-size:13px; }
button:hover{background:#3367D6;}
textarea,input[type=url],input[type=email],input[type=text]{width:80%;max-width:420px;border-radius:6px;border:1px solid #ccc;padding:6px;margin:4px 0;}
textarea{height:100px; resize:none;}
.note{background:#fff;padding:10px;border-radius:8px;margin-bottom:10px;box-shadow:0 2px 4px rgba(0,0,0,0.1); text-align:left; position:relative;}
.note img{max-width:100%; margin-top:4px;border-radius:4px; cursor:pointer;}
small{color:gray; display:block; margin-top:4px;}
a{color:#4285F4; word-break:break-all;}
.link-div{margin-top:2px;}

/* èŠå¤©å®¤æ¨£å¼ */
#chatWindow{
  display:none;
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:#f2f5fa;
  z-index:1000;
  flex-direction:column;
}
#chatBox{flex:1; overflow-y:auto; padding:10px; display:flex; flex-direction:column;}
.chat-container{display:flex; margin-bottom:6px;}
.chat-container.me{justify-content:flex-end;}
.chat-container.other{justify-content:flex-start;}
.chat-msg{max-width:70%; word-break:break-word; padding:8px 12px; border-radius:12px; display:flex; flex-direction:column;}
.chat-container.me .chat-msg{background:#4285F4;color:white;}
.chat-container.other .chat-msg{background:#e0e0e0;color:black;}
.chat-nickname{font-weight:bold; font-size:14px; margin-bottom:2px;}
.chat-content{font-size:12px; white-space:pre-wrap;}
.chat-time{font-size:10px; color:gray; text-align:right; margin-top:2px;}
#chatInput{width:90%; max-width:800px; min-width:200px; height:60px; padding:8px; margin:10px auto; display:block; border-radius:8px; border:1px solid #ccc; resize:none; font-size:14px; box-sizing:border-box;}
#sendBtn{width:90%; max-width:800px; margin:0 auto 10px auto; display:block; padding:8px; border-radius:6px; background:#4285F4; color:white; border:none; cursor:pointer; font-size:14px;}
#sendBtn:hover{background:#3367D6;}
</style>
</head>
<body>
<h1>ğŸ“˜ è¯çµ¡ç°¿ç³»çµ±</h1>

<div id="login-section">
  <button onclick="googleLogin();">ä½¿ç”¨ Google ç™»å…¥</button>
</div>

<div id="app" style="display:none;">
  <p id="user-info"></p>
  <button onclick="logout()">ç™»å‡º</button>

  <!-- è€å¸«é¢æ¿ -->
  <div id="teacher-panel" style="display:none;">
    <h3>âœï¸ è€å¸«å¯«è¯çµ¡ç°¿</h3>
    <textarea id="note" placeholder="è¼¸å…¥è¯çµ¡ç°¿å…§å®¹..." onkeydown="handleEnter(event)"></textarea><br>
    <input type="url" id="linkInput" placeholder="æ–°å¢è¶…é€£çµ (https://...)"><br>
    <input type="file" id="imageInput" accept="image/*" onchange="previewImage(event)"><br>
    <img id="preview" style="display:none"><br>
    <button onclick="addNote()">é€å‡º</button>
  </div>

  <!-- æœ€é«˜æ¬Šé™é¢æ¿ -->
  <div id="admin-panel" style="display:none;">
    <h3>ğŸ›  æ•™å¸«å¸³è™Ÿç®¡ç†ï¼ˆæœ€é«˜æ¬Šé™ï¼‰</h3>
    <input type="email" id="newTeacherEmail" placeholder="è¼¸å…¥æ•™å¸«Email">
    <button onclick="addTeacher()">æ–°å¢æ•™å¸«</button><br>
    <input type="email" id="deleteTeacherEmail" placeholder="è¼¸å…¥æ•™å¸«Emailåˆªé™¤">
    <button onclick="removeTeacher()">åˆªé™¤æ•™å¸«</button>
  </div>

  <div id="student-panel">
    <h3>ğŸ“– æœ€æ–°è¯çµ¡ç°¿</h3>
    <div id="messages"></div>

    <!-- åªçµ¦è€å¸«çœ‹çš„å›æ”¶ç«™ -->
    <div id="recycle-section" style="display:none;">
      <h3>ğŸ—‘ å›æ”¶ç«™ï¼ˆè€å¸«å¯è¦‹ï¼‰</h3>
      <div id="recycle"></div>
    </div>
  </div>
</div>

<!-- æµ®å‹•èŠå¤©å®¤æŒ‰éˆ• -->
<button id="chatBtn" onclick="toggleChat()" style="position:fixed;bottom:20px;right:20px;border-radius:50%;width:50px;height:50px;font-size:24px;z-index:999;">ğŸ’¬</button>

<!-- å…¨è¢å¹•èŠå¤©å®¤ -->
<div id="chatWindow">
  <div style="padding:10px; background:#4285F4; color:white; display:flex; justify-content:space-between; align-items:center;">
    <span>å­¸ç”ŸèŠå¤©å®¤</span>
    <input id="nicknameInput" type="text" placeholder="æš±ç¨±" style="width:150px;" onblur="saveNickname()">
    <button style="background:#f44336;padding:4px 8px;" onclick="closeChat()">è¿”å›è¯çµ¡ç°¿</button>
  </div>
  <div id="chatBox"></div>
  <textarea id="chatInput" placeholder="è¼¸å…¥è¨Šæ¯...(Shift+Enteræ›è¡Œ)" onkeydown="handleChatEnter(event)"></textarea>
  <button id="sendBtn" onclick="sendChat()">é€å‡º</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, collection, addDoc, doc, setDoc, getDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

const firebaseConfig={
  apiKey:"AIzaSyAPJ_QfW6IurPiSFg1yrcrr3eu2eoLMXqM",
  authDomain:"text-585a6.firebaseapp.com",
  projectId:"text-585a6",
  storageBucket:"text-585a6.appspot.com",
  messagingSenderId:"789195223699",
  appId:"1:789195223699:web:847902083fb646bda25366"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);
const provider = new GoogleAuthProvider();

let role="student", isAdmin=false, nickname=localStorage.getItem('nickname')||'æˆ‘';

// ç™»å…¥ç™»å‡º
async function googleLogin(){ try{ await signInWithPopup(auth,provider); } catch(e){ alert("ç™»å…¥å¤±æ•—:"+e.message);} }
async function logout(){ await signOut(auth); location.reload(); }

// è¼¸å…¥ Enter é€å‡º
function handleEnter(e){ if(e.key==="Enter"&&!e.shiftKey){ e.preventDefault(); addNote(); } }
function handleChatEnter(e){ if(e.key==="Enter"&&!e.shiftKey){ e.preventDefault(); sendChat(); } }

// é è¦½åœ–ç‰‡
function previewImage(event){ 
  const preview=document.getElementById("preview"); 
  const file=event.target.files[0]; 
  if(file){ 
    const reader=new FileReader(); 
    reader.onload=e=>{preview.src=e.target.result; preview.style.display="block";}; 
    reader.readAsDataURL(file);
  } else{preview.src=""; preview.style.display="none";} 
}

// èŠå¤©å®¤é–‹é—œèˆ‡æš±ç¨±å„²å­˜
function toggleChat(){ const win=document.getElementById("chatWindow"); win.style.display=(win.style.display==="none" || win.style.display==="")?"flex":"none"; }
function closeChat(){ document.getElementById("chatWindow").style.display="none"; }
function saveNickname(){ const val=document.getElementById("nicknameInput").value.trim(); if(val){ nickname=val; localStorage.setItem('nickname',nickname); } }

// ç™»å…¥å¾Œåˆ¤æ–·è§’è‰²
onAuthStateChanged(auth,async(user)=>{
  if(user){
    document.getElementById("login-section").style.display="none"; 
    document.getElementById("app").style.display="block";
    document.getElementById("user-info").innerText=`ğŸ‘‹ æ­¡è¿ ${user.displayName}`;

    const userRef=doc(db,"users",user.email); 
    const userDoc=await getDoc(userRef);
    if(!userDoc.exists()){ await setDoc(userRef,{role:"student"});} 
    else{ role=userDoc.data().role; }
    
    if(user.email==="chianghansen0302@gmail.com") isAdmin=true;
    if(role==="teacher") document.getElementById("teacher-panel").style.display="block";
    if(isAdmin) document.getElementById("admin-panel").style.display="block";
    if(role==="teacher") document.getElementById("recycle-section").style.display="block";
    
    nickname=localStorage.getItem('nickname')||user.displayName||'æˆ‘';
    document.getElementById("nicknameInput").value=nickname;

    listenNotes();
    listenRecycle();
    listenChat(); // å•Ÿå‹•èŠå¤©å®¤è¨Šæ¯ç›£è½
  }
});

// è¯çµ¡ç°¿åŠŸèƒ½
async function addNote(){
  const text=document.getElementById("note").value.trim();
  const link=document.getElementById("linkInput").value.trim();
  const imageFile=document.getElementById("imageInput").files[0];
  if(!text && !link && !imageFile) return alert("è«‹è¼¸å…¥å…§å®¹");

  let imageUrl="";
  if(imageFile){
    const imgRef=ref(storage,"notes/"+Date.now()+"_"+imageFile.name);
    await uploadBytes(imgRef,imageFile);
    imageUrl=await getDownloadURL(imgRef);
  }

  await addDoc(collection(db,"notes"),{
    text,
    link,
    image:imageUrl,
    author:auth.currentUser.email,
    timestamp:Date.now(),
    deleted:false
  });
  document.getElementById("note").value="";
  document.getElementById("linkInput").value="";
  document.getElementById("imageInput").value="";
  document.getElementById("preview").style.display="none";
}

// ç›£è½è¯çµ¡ç°¿
function listenNotes(){
  const q=query(collection(db,"notes"),orderBy("timestamp","desc"));
  onSnapshot(q,snapshot=>{
    const messages=document.getElementById("messages");
    messages.innerHTML="";
    snapshot.forEach(doc=>{
      const data=doc.data();
      if(data.deleted) return; // åˆªé™¤çš„å…ˆä¸é¡¯ç¤º
      const div=document.createElement("div");
      div.className="note";
      div.innerHTML=`<div>${data.text}</div>
        ${data.link?`<div class="link-div"><a href="${data.link}" target="_blank">${data.link}</a></div>`:""}
        ${data.image?`<img src="${data.image}">`:''}`;
      if(role==="teacher"){
        div.innerHTML+=`<button onclick="deleteNote('${doc.id}')">åˆªé™¤</button>`;
      }
      messages.appendChild(div);
    });
  });
}

// å›æ”¶ç«™
function listenRecycle(){
  const q=query(collection(db,"notes"),orderBy("timestamp","desc"));
  onSnapshot(q,snapshot=>{
    const recycle=document.getElementById("recycle");
    recycle.innerHTML="";
    snapshot.forEach(doc=>{
      const data=doc.data();
      if(!data.deleted) return;
      const div=document.createElement("div");
      div.className="note";
      div.innerHTML=`<div>${data.text}</div>
        ${data.link?`<div class="link-div"><a href="${data.link}" target="_blank">${data.link}</a></div>`:""}
        ${data.image?`<img src="${data.image}">`:''}
        <button onclick="restoreNote('${doc.id}')">å¾©åŸ</button>`;
      recycle.appendChild(div);
    });
  });
}

async function deleteNote(id){ await setDoc(doc(db,"notes",id),{deleted:true},{merge:true}); }
async function restoreNote(id){ await setDoc(doc(db,"notes",id),{deleted:false},{merge:true}); }

// æ•™å¸«ç®¡ç†ï¼ˆæœ€é«˜æ¬Šé™ï¼‰
async function addTeacher(){
  const email=document.getElementById("newTeacherEmail").value.trim();
  if(!email) return;
  await setDoc(doc(db,"users",email),{role:"teacher"});
  alert("æ–°å¢æ•™å¸«æˆåŠŸ");
}
async function removeTeacher(){
  const email=document.getElementById("deleteTeacherEmail").value.trim();
  if(!email) return;
  await setDoc(doc(db,"users",email),{role:"student"});
  alert("åˆªé™¤æ•™å¸«æˆåŠŸ");
}

// èŠå¤©å®¤ç›£è½
function listenChat(){
  const q=query(collection(db,"chat"),orderBy("timestamp","asc"));
  onSnapshot(q,snapshot=>{
    const chatBox=document.getElementById("chatBox");
    chatBox.innerHTML="";
    snapshot.forEach(doc=>{
      const data=doc.data();
      const div=document.createElement("div");
      div.className=(data.author===auth.currentUser.email)?"chat-container me":"chat-container other";
      div.innerHTML=`<div class="chat-msg">
        <span class="chat-nickname">${data.nickname}</span>
        <span class="chat-content">${data.message}</span>
        <span class="chat-time">${new Date(data.timestamp).toLocaleTimeString()}</span>
      </div>`;
      chatBox.appendChild(div);
      chatBox.scrollTop=chatBox.scrollHeight;
    });
  });
}

// ç™¼é€èŠå¤©è¨Šæ¯
async function sendChat(){
  const msg=document.getElementById("chatInput").value.trim();
  if(!msg) return;
  await addDoc(collection(db,"chat"),{
    nickname,
    message: msg,
    timestamp: Date.now(),
    author: auth.currentUser.email
  });
  document.getElementById("chatInput").value="";
}
</script>
</body>
</html>
