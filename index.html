<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>聯絡簿系統（最終版+聊天室）</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { font-family:"微軟正黑體"; background:#f2f5fa; text-align:center; padding:20px; }
h1 { color:#2c3e50; }
button { padding:6px 14px; background:#4285F4; color:white; border:none; border-radius:6px; cursor:pointer; margin:2px; font-size:13px; }
button:hover{background:#3367D6;}
textarea,input[type=url],input[type=email],input[type=text]{width:80%;max-width:420px;border-radius:6px;border:1px solid #ccc;padding:6px;margin:4px 0;}
textarea{resize:none;}
.note{background:#fff;padding:10px;border-radius:8px;margin-bottom:10px;box-shadow:0 2px 4px rgba(0,0,0,0.1); text-align:left; position:relative;}
.note img{max-width:100%; margin-top:4px;border-radius:4px; cursor:pointer;}
small{color:gray; display:block; margin-top:4px;}
a{color:#4285F4; word-break:break-all;}
.link-div{margin-top:2px;}

/* 聊天室 */
#chatWindow{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#f2f5fa;z-index:1000;flex-direction:column;}
#chatBox{flex:1; overflow-y:auto; padding:10px; display:flex; flex-direction:column;}
.chat-container{display:flex; margin-bottom:6px;}
.chat-container.me{justify-content:flex-end;}
.chat-container.other{justify-content:flex-start;}
.chat-msg{max-width:70%; word-break:break-word; padding:8px 12px; border-radius:12px; display:flex; flex-direction:column;}
.chat-container.me .chat-msg{background:#4285F4;color:white;}
.chat-container.other .chat-msg{background:#e0e0e0;color:black;}
.chat-nickname{font-weight:bold; font-size:14px; margin-bottom:2px;}
.chat-content{font-size:12px; white-space:pre-wrap;}
.chat-time{font-size:10px; color:gray; text-align:right; margin-top:2px;}
#chatInput{width:90%; max-width:800px; min-width:300px; height:120px; padding:10px; margin:10px auto; display:block; border-radius:8px; border:1px solid #ccc; resize:vertical; font-size:14px; box-sizing:border-box;}
#sendBtn{width:90%; max-width:800px; margin:0 auto 10px auto; display:block; padding:10px; border-radius:6px; background:#4285F4; color:white; border:none; cursor:pointer; font-size:16px;}
#sendBtn:hover{background:#3367D6;}
</style>
</head>
<body>
<h1>📘 聯絡簿系統</h1>

<div id="login-section">
  <button onclick="googleLogin();">使用 Google 登入</button>
</div>

<div id="app" style="display:none;">
  <p id="user-info"></p>
  <button onclick="logout()">登出</button>

  <!-- 老師面板 -->
  <div id="teacher-panel" style="display:none;">
    <h3>✏️ 老師寫聯絡簿</h3>
    <textarea id="note" placeholder="輸入聯絡簿內容..." onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault(); addNote();}"></textarea><br>
    <input type="url" id="linkInput" placeholder="新增超連結 (https://...)"><br>
    <input type="file" id="imageInput" accept="image/*" onchange="previewImage(event)"><br>
    <img id="preview" style="display:none"><br>
    <button onclick="addNote()">送出</button>
  </div>

  <!-- 最高權限面板 -->
  <div id="admin-panel" style="display:none;">
    <h3>🛠 教師帳號管理（最高權限）</h3>
    <input type="email" id="newTeacherEmail" placeholder="輸入教師Email">
    <button onclick="addTeacher()">新增教師</button><br>
    <input type="email" id="deleteTeacherEmail" placeholder="輸入教師Email刪除">
    <button onclick="removeTeacher()">刪除教師</button>
  </div>

  <div id="student-panel">
    <h3>📖 最新聯絡簿</h3>
    <div id="messages"></div>

    <div id="recycle-section" style="display:none;">
      <h3>🗑 回收站（老師可見）</h3>
      <div id="recycle"></div>
    </div>
  </div>
</div>

<!-- 浮動聊天室按鈕 -->
<button id="chatBtn" onclick="toggleChat()" style="position:fixed;bottom:20px;right:20px;border-radius:50%;width:50px;height:50px;font-size:24px;z-index:999;">💬</button>

<!-- 聊天室 -->
<div id="chatWindow">
  <div style="padding:10px; background:#4285F4; color:white; display:flex; justify-content:space-between; align-items:center;">
    <span>學生聊天室</span>
    <input id="nicknameInput" type="text" placeholder="暱稱" style="width:150px;" onblur="saveNickname()">
    <button style="background:#f44336;padding:4px 8px;" onclick="toggleChat()">返回聯絡簿</button>
  </div>
  <div id="chatBox"></div>
  <textarea id="chatInput" placeholder="輸入訊息...(Shift+Enter換行)" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault(); sendChat();}"></textarea>
  <button id="sendBtn" onclick="sendChat()">送出</button>
</div>

<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js"></script>
<script>
const firebaseConfig = {
  apiKey:"AIzaSyAPJ_QfW6IurPiSFg1yrcrr3eu2eoLMXqM",
  authDomain:"text-585a6.firebaseapp.com",
  projectId:"text-585a6",
  storageBucket:"text-585a6.appspot.com",
  messagingSenderId:"789195223699",
  appId:"1:789195223699:web:847902083fb646bda25366"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();
let role="student", isAdmin=false, nickname=localStorage.getItem('nickname')||'我';

async function googleLogin(){
  try{
    await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
  } catch(e){
    alert("登入失敗:"+e.message);
  }
}
async function logout(){ await auth.signOut(); location.reload(); }
function toggleChat(){ document.getElementById("chatWindow").style.display=document.getElementById("chatWindow").style.display==="none"?"flex":"none"; }
function saveNickname(){ let val=document.getElementById("nicknameInput").value.trim(); if(val){ nickname=val; localStorage.setItem('nickname',nickname); } }
function previewImage(e){ const file=e.target.files[0]; const preview=document.getElementById("preview"); if(file){ const reader=new FileReader(); reader.onload=function(ev){preview.src=ev.target.result; preview.style.display="block";}; reader.readAsDataURL(file);} else{preview.src=""; preview.style.display="none";} }

auth.onAuthStateChanged(async user=>{
  if(user){
    document.getElementById("login-section").style.display="none";
    document.getElementById("app").style.display="block";
    document.getElementById("user-info").innerText=`👋 歡迎 ${user.displayName}`;
    const userRef = db.collection("users").doc(user.email);
    const userDoc = await userRef.get();
    if(!userDoc.exists){ await userRef.set({role:"student"}); } 
    else { role = userDoc.data().role; }
    if(user.email==="chianghansen0302@gmail.com") isAdmin=true;
    if(role==="teacher") document.getElementById("teacher-panel").style.display="block";
    if(isAdmin) document.getElementById("admin-panel").style.display="block";
    if(role==="teacher") document.getElementById("recycle-section").style.display="block";
    nickname = localStorage.getItem('nickname') || user.displayName || '我';
    document.getElementById("nicknameInput").value = nickname;
    loadNotes();
    loadChat();
  }
});

// 聯絡簿功能
async function addNote(){
  const content=document.getElementById("note").value.trim();
  const link=document.getElementById("linkInput").value.trim();
  const imageFile=document.getElementById("imageInput").files[0];
  if(!content && !link && !imageFile){ alert("請輸入內容"); return; }

  let imageUrl="";
  if(imageFile){
    const storageRef = storage.ref("images/"+Date.now()+"_"+imageFile.name);
    await storageRef.put(imageFile);
    imageUrl = await storageRef.getDownloadURL();
  }

  await db.collection("notes").add({
    content, link, imageUrl, author:nickname, deleted:false, timestamp:firebase.firestore.FieldValue.serverTimestamp()
  });
  document.getElementById("note").value="";
  document.getElementById("linkInput").value="";
  document.getElementById("imageInput").value="";
  document.getElementById("preview").style.display="none";
}

// 載入聯絡簿
function loadNotes(){
  db.collection("notes").orderBy("timestamp","desc").onSnapshot(snapshot=>{
    const messages=document.getElementById("messages");
    const recycle=document.getElementById("recycle");
    messages.innerHTML=""; recycle.innerHTML="";
    snapshot.forEach(doc=>{
      const data=doc.data(); const id=doc.id;
      const div=document.createElement("div"); div.className="note";
      if(data.deleted && role!=="teacher") return;
      div.innerHTML=`<div>${data.content||""}</div>
        ${data.link?'<div class="link-div"><a href="'+data.link+'" target="_blank">'+data.link+'</a></div>':""}
        ${data.imageUrl?'<img src="'+data.imageUrl+'">':""}
        <small>${data.author} - ${data.timestamp?.toDate?.()?.toLocaleString()||""}</small>`;
      if(role==="teacher"){
        const btnDel=document.createElement("button"); btnDel.innerText=data.deleted?"復原":"刪除";
        btnDel.onclick=()=>db.collection("notes").doc(id).update({deleted:!data.deleted});
        div.appendChild(btnDel);
        const btnEdit=document.createElement("button"); btnEdit.innerText="編輯";
        btnEdit.onclick=()=>{
          const newContent=prompt("編輯內容",data.content||"");
          if(newContent!==null) db.collection("notes").doc(id).update({content:newContent});
        };
        div.appendChild(btnEdit);
        if(data.deleted) recycle.appendChild(div);
        else messages.appendChild(div);
      } else { messages.appendChild(div); }
    });
  });
}

// 聊天室
function sendChat(){
  const msg=document.getElementById("chatInput").value.trim();
  if(!msg) return;
  db.collection("chat").add({
    author:nickname, content:msg, timestamp:firebase.firestore.FieldValue.serverTimestamp()
  });
  document.getElementById("chatInput").value="";
}
function loadChat(){
  db.collection("chat").orderBy("timestamp","asc").onSnapshot(snapshot=>{
    const box=document.getElementById("chatBox"); box.innerHTML="";
    snapshot.forEach(doc=>{
      const data=doc.data();
      const div=document.createElement("div"); div.className="chat-container "+(data.author===nickname?"me":"other");
      div.innerHTML=`<div class="chat-msg"><div class="chat-nickname">${data.author}</div>
        <div class="chat-content">${data.content}</div>
        <div class="chat-time">${data.timestamp?.toDate?.()?.toLocaleTimeString()||""}</div></div>`;
      box.appendChild(div); box.scrollTop=box.scrollHeight;
    });
  });
}

// 教師管理
async function addTeacher(){
  const email=document.getElementById("newTeacherEmail").value.trim();
  if(!email) return;
  await db.collection("users").doc(email).set({role:"teacher"});
}
async function removeTeacher(){
  const email=document.getElementById("deleteTeacherEmail").value.trim();
  if(!email) return;
  await db.collection("users").doc(email).delete();
}
</script>
</body>
</html>
