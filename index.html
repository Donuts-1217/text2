<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>è¯çµ¡ç°¿ç³»çµ±ï¼ˆå¤šé€£çµï¼‹è‡ªå‹•è¶…é€£çµï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { font-family: "å¾®è»Ÿæ­£é»‘é«”"; background: #f2f5fa; text-align: center; padding: 30px; }
h1 { color: #2c3e50; }
button { padding: 6px 14px; background: #4285F4; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; margin:2px; }
button:hover { background: #3367D6; }
textarea, input[type=url], input[type=email] { width: 80%; max-width: 420px; margin-top: 10px; border-radius: 6px; border: 1px solid #ccc; padding: 8px; }
textarea { height: 100px; resize: none; }
input[type=file] { margin-top: 5px; }
.note { background: #fff; padding: 12px; border-radius: 10px; margin-bottom: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); position: relative; text-align:left; }
.note img { max-width: 100%; margin-top: 5px; border-radius: 6px; }
.editable { min-height: 20px; white-space: pre-wrap; } 
small { color: gray; display: block; margin-top: 5px; }
hr { margin: 25px 0; border: 0.5px solid #ccc; }
a { color: #4285F4; word-break: break-all; }
.link-div { margin-top:4px; }
</style>
</head>
<body>
<h1>ğŸ“˜ è¯çµ¡ç°¿ç³»çµ±</h1>

<div id="login-section">
  <button onclick="googleLogin();">ä½¿ç”¨ Google ç™»å…¥</button>
</div>

<div id="app" style="display:none;">
  <p id="user-info"></p>
  <button onclick="logout()">ç™»å‡º</button>

  <!-- è€å¸«é¢æ¿ -->
  <div id="teacher-panel" style="display:none;">
    <h3>âœï¸ è€å¸«å¯«è¯çµ¡ç°¿</h3>
    <textarea id="note" placeholder="è¼¸å…¥è¯çµ¡ç°¿å…§å®¹..." onkeydown="handleEnter(event)"></textarea><br>
    <input type="url" id="linkInput" placeholder="æ–°å¢è¶…é€£çµ (https://...)"><br>
    <input type="file" id="imageInput" accept="image/*" onchange="previewImage(event)"><br>
    <img id="preview" style="display:none"><br>
    <button onclick="addNote()">é€å‡º</button>
  </div>

  <!-- æœ€é«˜æ¬Šé™é¢æ¿ -->
  <div id="admin-panel" style="display:none;">
    <h3>ğŸ›  æ•™å¸«å¸³è™Ÿç®¡ç†ï¼ˆæœ€é«˜æ¬Šé™ï¼‰</h3>
    <input type="email" id="newTeacherEmail" placeholder="è¼¸å…¥æ•™å¸«Email">
    <button onclick="addTeacher()">æ–°å¢æ•™å¸«</button><br>
    <input type="email" id="deleteTeacherEmail" placeholder="è¼¸å…¥æ•™å¸«Emailåˆªé™¤">
    <button onclick="removeTeacher()">åˆªé™¤æ•™å¸«</button>
  </div>

  <div id="student-panel">
    <h3>ğŸ“– æœ€æ–°è¯çµ¡ç°¿</h3>
    <div id="messages"></div>

    <hr>

    <h3>ğŸ•’ æ­·å²ç´€éŒ„</h3>
    <div id="history"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, collection, addDoc, doc, setDoc, query, onSnapshot, getDocs, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyAPJ_QfW6IurPiSFg1yrcrr3eu2eoLMXqM",
  authDomain: "text-585a6.firebaseapp.com",
  projectId: "text-585a6",
  storageBucket: "text-585a6.appspot.com",
  messagingSenderId: "789195223699",
  appId: "1:789195223699:web:847902083fb646bda25366",
  measurementId: "G-FL11M47EFP"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);
const provider = new GoogleAuthProvider();

let role = "student";
let isAdmin = false;

async function googleLogin() {
  try { await signInWithPopup(auth, provider); } 
  catch(e) { alert("ç™»å…¥å¤±æ•—ï¼š" + e.message); console.error(e); }
}

async function logout() { await signOut(auth); location.reload(); }

function handleEnter(e){
  if(e.key === "Enter" && !e.shiftKey){
    e.preventDefault();
    addNote(false);
  }
}

function previewImage(event){
  const preview = document.getElementById("preview");
  const file = event.target.files[0];
  if(file){
    const reader = new FileReader();
    reader.onload = e=>{ preview.src = e.target.result; preview.style.display="block"; };
    reader.readAsDataURL(file);
  } else { preview.src=""; preview.style.display="none"; }
}

// å°‡æ–‡å­—è‡ªå‹•è½‰è¶…é€£çµ
function linkify(text){
  const urlPattern = /(https?:\/\/[^\s]+)/g;
  return text.replace(urlPattern, "<a href='$1' target='_blank'>$1</a>");
}

// æ–°å¢ç­†è¨˜
async function addNote(update=false, docId=null, div=null){
  const content = document.getElementById("note").value.trim();
  const link = document.getElementById("linkInput").value.trim() || null;
  const fileInput = document.getElementById("imageInput");
  if(!content && !fileInput.files.length && !link) return alert("è«‹è¼¸å…¥å…§å®¹ã€åœ–ç‰‡æˆ–é€£çµï¼");

  let imageUrl = null;
  if(fileInput.files.length>0){
    const file = fileInput.files[0];
    const storageRef = ref(storage, `notes/${Date.now()}_${file.name}`);
    await uploadBytes(storageRef,file);
    imageUrl = await getDownloadURL(storageRef);
  }

  if(update && docId && div){
    const text = div.innerText;
    await setDoc(doc(db,"notes",docId),{
      author: div.dataset.author,
      email: div.dataset.email,
      content: text,
      imageUrl: div.dataset.newImage || div.dataset.image || imageUrl || null,
      links: div.dataset.links ? JSON.parse(div.dataset.links) : (link?[link]:[]),
      time: new Date().toLocaleString()
    });
    div.dataset.image = div.dataset.newImage || div.dataset.image || imageUrl || null;
    div.dataset.newImage = "";
  } else {
    const newLinks = link ? [link] : [];
    await addDoc(collection(db,"notes"),{
      author: auth.currentUser.displayName,
      email: auth.currentUser.email,
      content: content,
      imageUrl: imageUrl,
      links: newLinks,
      time: new Date().toLocaleString()
    });

    // ä¿ç•™æœ€è¿‘10ç­†
    const notesSnapshot = await getDocs(collection(db,"notes"));
    const docs = notesSnapshot.docs.sort((a,b)=>new Date(b.data().time)-new Date(a.data().time));
    if(docs.length>10){
      for(let i=10;i<docs.length;i++){
        await deleteDoc(doc(db,"notes",docs[i].id));
      }
    }
  }

  document.getElementById("note").value="";
  document.getElementById("linkInput").value="";
  fileInput.value="";
  document.getElementById("preview").style.display="none";
}

// æœ€é«˜æ¬Šé™æ•™å¸«ç®¡ç†
async function addTeacher(){
  const email = document.getElementById("newTeacherEmail").value.trim();
  if(!email) return alert("è«‹è¼¸å…¥Email");
  await setDoc(doc(db,"users",email), {role:"teacher"});
  alert(email+" å·²è¨­ç‚ºæ•™å¸«");
}

async function removeTeacher(){
  const email = document.getElementById("deleteTeacherEmail").value.trim();
  if(!email) return alert("è«‹è¼¸å…¥Email");
  const userRef = doc(db,"users",email);
  await setDoc(userRef, {role:"student"});
  alert(email+" å·²ç§»é™¤æ•™å¸«æ¬Šé™");
}

// åˆªé™¤ç­†è¨˜
async function deleteNote(docId){
  if(confirm("ç¢ºå®šè¦åˆªé™¤æ­¤ç­†è¨˜å—ï¼Ÿ")) await deleteDoc(doc(db,"notes",docId));
}

// æ–°å¢/ç·¨è¼¯/åˆªé™¤å¤šé€£çµ
async function addLink(docId){
  const input = document.getElementById(`newLink_${docId}`);
  const url = input.value.trim();
  if(!url) return alert("è«‹è¼¸å…¥é€£çµ");
  
  const noteRef = doc(db,"notes",docId);
  const noteSnap = await getDoc(noteRef);
  const data = noteSnap.data();
  const links = data.links || [];
  links.push(url);
  await setDoc(noteRef,{...data, links: links});
  input.value="";
}

async function deleteLink(docId,index){
  if(!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤é€£çµå—ï¼Ÿ")) return;
  const noteRef = doc(db,"notes",docId);
  const noteSnap = await getDoc(noteRef);
  const data = noteSnap.data();
  const links = data.links || [];
  links.splice(index,1);
  await setDoc(noteRef,{...data, links: links});
}

async function editLink(docId,index){
  const newUrl = prompt("ç·¨è¼¯é€£çµ", "");
  if(!newUrl) return;
  const noteRef = doc(db,"notes",docId);
  const noteSnap = await getDoc(noteRef);
  const data = noteSnap.data();
  const links = data.links || [];
  links[index] = newUrl;
  await setDoc(noteRef,{...data, links: links});
}

// ç›£è½ç™»å…¥ç‹€æ…‹
onAuthStateChanged(auth, async (user)=>{
  if(user){
    document.getElementById("login-section").style.display="none";
    document.getElementById("app").style.display="block";
    document.getElementById("user-info").innerText = `ğŸ‘‹ æ­¡è¿ ${user.displayName}`;

    // å–å¾—è§’è‰²
    const userRef = doc(db,"users",user.email);
    const userSnap = await getDoc(userRef);
    if(!userSnap.exists()){
      await setDoc(userRef, {role:"student"});
      role = "student";
    } else role = userSnap.data().role;

    // è€å¸«é¡¯ç¤ºé¢æ¿
    if(role==="teacher") document.getElementById("teacher-panel").style.display="block";
    // æœ€é«˜æ¬Šé™
    if(user.email==="chianghansen0302@gmail.com"){ document.getElementById("admin-panel").style.display="block"; isAdmin=true; }

    // ç›£è½ç­†è¨˜
    const q = query(collection(db,"notes"));
    onSnapshot(q,snapshot=>{
      const messages = snapshot.docs.sort((a,b)=>new Date(b.data().time)-new Date(a.data().time));
      let html = "", histHtml="";
      messages.forEach(doc=>{
        const data = doc.data();
        const linksHTML = (data.links||[]).map((l,i)=>{
          return `<div class='link-div'>
                    <a href='${l}' target='_blank'>${l}</a>
                    ${role==="teacher"?`<button onclick='editLink("${doc.id}",${i})'>ç·¨è¼¯</button>
                    <button onclick='deleteLink("${doc.id}",${i})'>åˆªé™¤</button>`:""}
                  </div>`;
        }).join("");

        const imageHTML = data.imageUrl ? `<img src='${data.imageUrl}'>` : "";

        const noteDiv = `<div class='note' data-author='${data.author}' data-email='${data.email}' data-image='${data.imageUrl||""}' data-links='${JSON.stringify(data.links||[])}'>
            <div class='editable' contenteditable='${role==="teacher"}'>${linkify(data.content).replace(/\n/g,"<br>")}</div>
            ${imageHTML}
            ${linksHTML}
            <small>${data.author} | ${data.time}</small>
            ${role==="teacher"?`<button onclick='deleteNote("${doc.id}")'>åˆªé™¤ç­†è¨˜</button>`:""}
          </div>`;

        html += noteDiv;
        histHtml += noteDiv;
      });
      document.getElementById("messages").innerHTML = html;
      document.getElementById("history").innerHTML = histHtml;
    });

  }
});

window.googleLogin = googleLogin;
window.logout = logout;
window.addNote = addNote;
window.addTeacher = addTeacher;
window.removeTeacher = removeTeacher;
window.addLink = addLink;
window.deleteLink = deleteLink;
window.editLink = editLink;
</script>
</body>
</html>
