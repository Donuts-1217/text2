<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<title>è¯çµ¡ç°¿ç³»çµ±ï¼ˆè€å¸«/ç®¡ç†å“¡å›è¦†ç§å¯†ï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body { font-family: "å¾®è»Ÿæ­£é»‘é«”", Arial, sans-serif; background:#f2f5fa; color:#222; padding:18px; text-align:center; }
  h1 { color:#2c3e50; }
  .btn { padding:8px 12px; border-radius:8px; border:none; background:#4285F4; color:white; cursor:pointer; margin:4px; }
  .btn:active{transform:translateY(1px)}
  textarea,input{ width:80%; max-width:480px; padding:8px; border-radius:6px; border:1px solid #ccc; }
  .note, .reply-box { background:#fff; padding:12px; border-radius:10px; margin:10px auto; box-shadow:0 2px 6px rgba(0,0,0,0.08); text-align:left; max-width:640px; }
  .reply-box { background:#fbfbfb; margin-left:28px; }
  small { color:#666; }
  .controls { margin-top:8px; }
  .meta { color:#666; font-size:13px; }
  .hidden { display:none; }
  .flex { display:flex; gap:8px; align-items:center; justify-content:center; flex-wrap:wrap; }
  .tag { background:#eef5ff; color:#2b66d6; padding:2px 8px; border-radius:12px; font-size:12px; }
</style>
</head>
<body>
  <h1>ğŸ“˜ è¯çµ¡ç°¿ç³»çµ±ï¼ˆå«ç§å¯†å›è¦†ï¼‰</h1>

  <div id="login-section">
    <button class="btn" onclick="googleLogin()">ä½¿ç”¨ Google ç™»å…¥</button>
  </div>

  <div id="app" class="hidden">
    <p id="user-info"></p>
    <div class="flex">
      <button class="btn" onclick="logout()">ç™»å‡º</button>
    </div>

    <!-- è€å¸«/ç®¡ç†å“¡ç™¼ä½ˆ -->
    <div id="teacher-panel" class="hidden" style="margin-top:12px;">
      <h3>âœï¸ ç™¼ä½ˆè¯çµ¡ç°¿</h3>
      <textarea id="note" placeholder="è¼¸å…¥å…§å®¹ï¼ˆShift+Enter æ›è¡Œï¼‰"></textarea><br>
      <div class="controls">
        <button class="btn" onclick="addNote()">ç™¼ä½ˆ</button>
      </div>
    </div>

    <hr style="max-width:760px; margin:18px auto;">

    <h3>ğŸ“œ è¯çµ¡ç°¿</h3>
    <div id="notes"></div>

  </div>

<script type="module" defer>
/* --------------------------------------------
   è¯çµ¡ç°¿ï¼šè€å¸«/ç®¡ç†å“¡èƒ½åˆªé™¤ã€ç·¨è¼¯ã€å›è¦†ï¼ˆå›è¦†å¯ internal/private/publicï¼‰
   ç§å¯†å›è¦† private åªçµ¦è©²å­¸ç”Ÿ + è€å¸«/ç®¡ç†å“¡çœ‹åˆ°
   replies å­˜åœ¨ notes/{noteId}/replies
----------------------------------------------*/

import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import {
  getFirestore, collection, addDoc, setDoc, doc, getDoc, getDocs,
  onSnapshot, deleteDoc, updateDoc, query, orderBy, serverTimestamp, where
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

// ---------- Firebase configï¼ˆä½¿ç”¨ä½ çµ¦çš„å°ˆæ¡ˆï¼‰ ----------
const firebaseConfig = {
  apiKey: "AIzaSyAPJ_QfW6IurPiSFg1yrcrr3eu2eoLMXqM",
  authDomain: "text-585a6.firebaseapp.com",
  projectId: "text-585a6",
  storageBucket: "text-585a6.firebasestorage.app",
  messagingSenderId: "789195223699",
  appId: "1:789195223699:web:847902083fb646bda25366",
  measurementId: "G-FL11M47EFP"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

let currentUser = null;
let currentRole = "student";

// ---------- å·¥å…·ï¼šæ ¼å¼åŒ–é¡¯ç¤ºï¼ˆæ›è¡Œ + é€£çµï¼‰ ----------
function formatTextForSave(text) {
  // å„²å­˜ HTML-safe: å°‡ < > escape å¾Œè™•ç†æ›è¡Œèˆ‡é€£çµ
  const esc = text.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  return esc.replace(/\n/g,"<br>").replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank">$1</a>');
}
function formatTextForDisplay(stored) {
  return stored; // å·²æ˜¯ HTML-safe + <br> + <a>
}

// ---------- æ–°å¢è¯çµ¡ç°¿ï¼ˆè€å¸«/ç®¡ç†å“¡ï¼‰ ----------
async function addNote() {
  if (currentRole !== "teacher" && currentRole !== "admin") {
    alert("åªæœ‰è€å¸«æˆ–ç®¡ç†å“¡å¯ä»¥ç™¼ä½ˆè¯çµ¡ç°¿ã€‚");
    return;
  }
  const ta = document.getElementById("note");
  const raw = ta.value.trim();
  if (!raw) return alert("è«‹è¼¸å…¥å…§å®¹");
  await addDoc(collection(db, "notes"), {
    author: currentUser.displayName,
    email: currentUser.email,
    content: formatTextForSave(raw),
    createdAt: serverTimestamp(),
    createdAtStr: new Date().toLocaleString()
  });
  ta.value = "";
}

// ---------- åˆªé™¤è¯çµ¡ç°¿ï¼ˆè€å¸«/ç®¡ç†å“¡ï¼‰ ----------
async function deleteNoteConfirmed(noteId) {
  // å…ˆè®€å–åŸå…§å®¹ã€å¯«å…¥ deleted_logï¼Œå†åˆªé™¤
  const noteRef = doc(db, "notes", noteId);
  const noteSnap = await getDoc(noteRef);
  if (!noteSnap.exists()) { alert("æ‰¾ä¸åˆ°è©²ç­†è³‡æ–™"); return; }
  const data = noteSnap.data();
  if (!confirm(`ç¢ºå®šåˆªé™¤æ­¤è¯çµ¡ç°¿ï¼Ÿ\n\n${data.author} â€” ${data.createdAtStr}`)) return;

  // å¯«å…¥ deleted_log
  await addDoc(collection(db, "deleted_log"), {
    type: "note",
    noteId,
    originalAuthor: data.author,
    originalEmail: data.email,
    originalContent: data.content,
    originalTime: data.createdAtStr,
    deletedBy: currentUser.displayName,
    deletedByEmail: currentUser.email,
    deletedByRole: currentRole,
    deletedAt: new Date().toLocaleString()
  });

  // åˆªé™¤ï¼ˆæ³¨æ„ï¼šé€™ä¸æœƒåˆª replies å­é›†åˆï¼›è‹¥è¦ä¸€ä½µåˆªå¯å†æ“´å……ï¼‰
  await deleteDoc(noteRef);
}

// ---------- ç·¨è¼¯è¯çµ¡ç°¿ï¼ˆè€å¸«/ç®¡ç†å“¡ï¼‰ ----------
async function editNotePrompt(noteId) {
  const noteRef = doc(db, "notes", noteId);
  const snap = await getDoc(noteRef);
  if (!snap.exists()) { alert("æ‰¾ä¸åˆ°è³‡æ–™"); return; }
  const data = snap.data();
  // å°‡ stored HTML è½‰å› plain æ–°è¼¸å…¥ï¼ˆç°¡å–®è™•ç†ï¼šæŠŠ <br> æ›æˆ \nï¼Œå»æ‰ a æ¨™ç±¤ï¼‰
  const plain = data.content.replace(/<br>/g, "\n").replace(/<a[^>]*>([^<]*)<\/a>/g, "$1").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&");
  const newText = prompt("ç·¨è¼¯è¯çµ¡ç°¿å…§å®¹ï¼š", plain);
  if (newText === null) return;
  await updateDoc(noteRef, {
    content: formatTextForSave(newText),
    editedAt: new Date().toLocaleString(),
    editedBy: currentUser.displayName
  });
}

// ---------- æ–°å¢å›è¦†ï¼ˆè€å¸«/ç®¡ç†å“¡ï¼‰ ----------
/*
  replyVisibility:
    - "internal" : åªæœ‰è€å¸«/ç®¡ç†å“¡çœ‹å¾—åˆ°
    - "public"   : æ‰€æœ‰äººçœ‹å¾—åˆ°
    - "private"  : åªæœ‰æŒ‡å®šå­¸ç”Ÿï¼ˆtoEmailï¼‰èˆ‡è€å¸«/ç®¡ç†å“¡çœ‹å¾—åˆ°
*/
async function addReplyPrompt(noteId) {
  if (currentRole !== "teacher" && currentRole !== "admin") {
    alert("åªæœ‰è€å¸«æˆ–ç®¡ç†å“¡å¯ä»¥å›è¦†ã€‚");
    return;
  }
  const text = prompt("è¼¸å…¥å›è¦†å…§å®¹ï¼ˆæ”¯æ´æ›è¡Œï¼šè¼¸å…¥ \\n ä»£è¡¨æ›è¡Œï¼Œæˆ–åœ¨æç¤ºå¾Œå†è²¼å¤šè¡Œï¼‰ï¼š");
  if (text === null || text.trim() === "") return;
  // è®“è€å¸«é¸æ“‡ visibility
  const vis = prompt("å›è¦†å¯è¦‹æ€§ï¼Ÿè¼¸å…¥ internal / public / privateï¼ˆprivate å‰‡éœ€è¼¸å…¥å­¸ç”Ÿ emailï¼‰", "internal");
  if (!vis) return;
  let toEmail = "";
  if (vis === "private") {
    toEmail = prompt("è«‹è¼¸å…¥è¦ç™¼çµ¦å“ªä½å­¸ç”Ÿçš„ Emailï¼ˆç¯„ä¾‹ï¼šstudent@example.comï¼‰");
    if (!toEmail) { alert("å¿…é ˆè¼¸å…¥å­¸ç”Ÿ Email"); return; }
  }
  await addDoc(collection(db, "notes", noteId, "replies"), {
    author: currentUser.displayName,
    authorEmail: currentUser.email,
    content: formatTextForSave(text.replace(/\\n/g,"\n")),
    visibility: vis,
    toEmail: toEmail || "",
    createdAt: serverTimestamp(),
    createdAtStr: new Date().toLocaleString()
  });
}

// ---------- åˆªé™¤å›è¦†ï¼ˆè€å¸«/ç®¡ç†å“¡ï¼‰ ----------
async function deleteReplyConfirmed(noteId, replyId) {
  const replyRef = doc(db, "notes", noteId, "replies", replyId);
  const snap = await getDoc(replyRef);
  if (!snap.exists()) { alert("æ‰¾ä¸åˆ°ç•™è¨€"); return; }
  const data = snap.data();
  if (!confirm("ç¢ºå®šåˆªé™¤æ­¤å›è¦†ï¼Ÿ")) return;
  // è¨˜éŒ„åˆªé™¤åˆ° deleted_log
  await addDoc(collection(db, "deleted_log"), {
    type: "reply",
    noteId,
    replyId,
    original: data,
    deletedBy: currentUser.displayName,
    deletedByEmail: currentUser.email,
    deletedByRole: currentRole,
    deletedAt: new Date().toLocaleString()
  });
  await deleteDoc(replyRef);
}

// ---------- è®€å–ä¸¦æ¸²æŸ“è¯çµ¡ç°¿èˆ‡å›è¦†ï¼ˆå³æ™‚ï¼‰ ----------
function renderNotesRealtime() {
  const notesContainer = document.getElementById("notes");
  const q = query(collection(db, "notes"), orderBy("createdAt", "desc"));
  onSnapshot(q, async (snapshot) => {
    notesContainer.innerHTML = "";
    // é€ç­†è™•ç†ï¼ˆåŒ…å«æŠ“ repliesï¼‰
    for (const docItem of snapshot.docs) {
      const noteId = docItem.id;
      const note = docItem.data();
      // fetch replies (ordered)
      const repliesSnap = await getDocs(query(collection(db, "notes", noteId, "replies"), orderBy("createdAt","asc")));
      // build replies HTML respecting visibility:
      let repliesHTML = "";
      repliesSnap.forEach((r) => {
        const d = r.data();
        // decide whether current user can see this reply
        const isTeacherOrAdmin = (currentRole === "teacher" || currentRole === "admin");
        let visible = false;
        if (d.visibility === "public") visible = true;
        else if (d.visibility === "internal" && isTeacherOrAdmin) visible = true;
        else if (d.visibility === "private" && (isTeacherOrAdmin || (currentUser && currentUser.email === d.toEmail))) visible = true;

        if (visible) {
          const delBtn = (isTeacherOrAdmin) ? `<button onclick="deleteReplyConfirmed('${noteId}','${r.id}')">åˆªé™¤å›è¦†</button>` : "";
          repliesHTML += `
            <div class="reply-box">
              <div class="meta"><b>${d.author}</b> <span style="color:#999">(${d.authorEmail})</span> ${d.visibility==='private' ? `<span class="tag">ç§äºº</span>` : d.visibility==='internal' ? `<span class="tag">å…§éƒ¨</span>` : `<span class="tag">å…¬é–‹</span>`}</div>
              <div>${formatTextForDisplay(d.content)}</div>
              <small>${d.createdAtStr || ""}</small>
              ${delBtn}
            </div>`;
        }
      });

      // actions for this note:
      const isTeacherOrAdmin = (currentRole === "teacher" || currentRole === "admin");
      const editBtn = isTeacherOrAdmin ? `<button onclick="editNotePrompt('${noteId}')">ç·¨è¼¯</button>` : "";
      const delBtn = isTeacherOrAdmin ? `<button onclick="deleteNoteConfirmed('${noteId}')">åˆªé™¤</button>` : "";
      const replyBtn = isTeacherOrAdmin ? `<button onclick="addReplyPrompt('${noteId}')">å›è¦†</button>` : "";

      // Build note HTML
      notesContainer.innerHTML += `
        <div class="note">
          <div class="meta"><b>${note.author}</b> <span style="color:#999">(${note.email})</span></div>
          <div style="margin-top:6px;">${formatTextForDisplay(note.content)}</div>
          <small>${note.createdAtStr || ""} ${note.editedAt ? ` Â· ç·¨è¼¯æ–¼ ${note.editedAt}ï¼ˆ${note.editedBy||""}ï¼‰` : ""}</small>
          <div class="controls">${editBtn} ${delBtn} ${replyBtn}</div>
          ${repliesHTML}
        </div>`;
    }
  });
}

// ---------- helper: show admin deleted_log (ç®¡ç†å“¡å¯çœ‹) ----------
function renderDeletedLogIfAdmin() {
  if (currentRole !== "admin") return;
  // ä½ å¯ä»¥æ–°å¢ä¸€å€‹ç®¡ç†é é¢é¡¯ç¤º deleted_logï¼›é€™è£¡åªåœ¨ console ç¤ºç¯„
  const q = query(collection(db, "deleted_log"), orderBy("deletedAt","desc"));
  onSnapshot(q, (snapshot) => {
    console.log("deleted_log updated:", snapshot.docs.map(d=>d.data()));
  });
}

// ---------- ç›£è½ç™»å…¥ç‹€æ…‹ ----------
onAuthStateChanged(auth, async (user) => {
  const loginSection = document.getElementById("login-section");
  const appSection = document.getElementById("app");
  if (!loginSection || !appSection) return;

  if (user) {
    currentUser = user;
    // hide login, show app
    loginSection.classList.add("hidden");
    appSection.classList.remove("hidden");
    document.getElementById("user-info").innerText = `ğŸ‘‹ æ­¡è¿ ${user.displayName} (${user.email})`;

    // ensure user role exists
    const userRef = doc(db, "users", user.email);
    const userSnap = await getDoc(userRef);
    if (!userSnap.exists()) {
      const role = (user.email === "chianghansen0302@gmail.com") ? "admin" : "student";
      await setDoc(userRef, { role });
      currentRole = role;
    } else {
      currentRole = userSnap.data().role || "student";
    }

    // teacher panel visible?
    if (currentRole === "teacher" || currentRole === "admin") {
      document.getElementById("teacher-panel").classList.remove("hidden");
    }

    // start realtime render
    renderNotesRealtime();
    renderNotesRealtime = renderNotesRealtime; // no-op to keep linter happy
    renderNotesRealtime(); // immediate call

    renderNotesRealtime = renderNotesRealtime; // keep reference
    // But we have function renderNotesRealtime defined earlier; call it:
    // (Note: we already called above)
    // Also render deleted_log if admin
    renderDeletedLogIfAdmin();
  }
});

// ---------- Enter / Shift+Enter è¡Œç‚ºï¼ˆå…¨åŸŸï¼‰ ----------
document.addEventListener("keydown", (e) => {
  const el = document.activeElement;
  if (!el) return;
  if (el.tagName === "TEXTAREA" && e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    // åˆ¤æ–·æ˜¯å“ªå€‹ textarea
    if (el.id === "note") {
      addNote();
    } else if (el.id === "chat-input") {
      // not used here â€” chat is separate file in your setup
    } else if (el.id && el.id.startsWith("reply-")) {
      // ä»¥ internal reply via inline textarea â€” but we used prompt-based replies above,
      // for inline replies you'd implement addReply(noteId) reading from that textarea.
    }
  }
});

// ---------- å…¬é–‹å‡½å¼ç¶åˆ° windowï¼ˆä¾› HTML button ä½¿ç”¨ï¼‰ ----------
window.googleLogin = async () => {
  try { await signInWithPopup(auth, provider); }
  catch (err) { alert("ç™»å…¥å¤±æ•—ï¼š" + err.message); }
};
window.logout = async () => { await signOut(auth); location.reload(); };
window.addNote = addNote;
window.addReplyPrompt = addReplyPrompt;
window.deleteNoteConfirmed = deleteNoteConfirmed;
window.editNotePrompt = editNotePrompt;
window.deleteReplyConfirmed = deleteReplyConfirmed;

// å°‡ formatTextForDisplay æš´éœ²ï¼ˆä¸Šé¢ä½¿ç”¨ï¼‰
window.formatTextForDisplay = formatTextForDisplay;

</script>
</body>
</html>
