<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>è¯çµ¡ç°¿ç³»çµ±</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, onSnapshot, setDoc, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    let currentUser = null;
    let currentRole = "student";

    // ğŸ”¹ ç™»å…¥
    document.getElementById("login-btn").addEventListener("click", async () => {
      await signInWithPopup(auth, provider);
    });

    // ğŸ”¹ ç™»å‡º
    document.getElementById("logout-btn").addEventListener("click", async () => {
      await signOut(auth);
    });

    // ğŸ”¹ ç™»å…¥ç‹€æ…‹ç›£è½
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        document.getElementById("login-page").style.display = "none";
        document.getElementById("main-page").style.display = "block";
        document.getElementById("user-info").textContent = user.email;

        // å–å¾—è§’è‰²
        const userDoc = doc(db, "users", user.email);
        const snap = await getDocs(collection(db, "users"));
        let found = false;
        snap.forEach((d) => {
          if (d.id === user.email) {
            currentRole = d.data().role;
            found = true;
          }
        });
        if (!found) {
          await setDoc(userDoc, { role: "student" });
          currentRole = "student";
        }

        setupRoleUI();
        renderContactBook();
      } else {
        document.getElementById("login-page").style.display = "block";
        document.getElementById("main-page").style.display = "none";
      }
    });

    // ğŸ”¹ æ ¹æ“šè§’è‰²é¡¯ç¤º UI
    function setupRoleUI() {
      document.getElementById("teacher-panel").style.display = (currentRole === "teacher" || currentRole === "admin") ? "block" : "none";
      document.getElementById("admin-panel").style.display = (currentRole === "admin") ? "block" : "none";
      document.getElementById("user-manager").style.display = (currentRole === "admin") ? "block" : "none";
    }

    // ğŸ”¹ æ–°å¢è¯çµ¡ç°¿
    document.getElementById("add-btn").addEventListener("click", async () => {
      const content = document.getElementById("note-input").value.trim();
      if (!content) return alert("è«‹è¼¸å…¥å…§å®¹");
      await addDoc(collection(db, "contactbook"), {
        author: currentUser.email,
        content,
        time: Date.now()
      });
      document.getElementById("note-input").value = "";
    });

    // ğŸ”¹ é¡¯ç¤ºè¯çµ¡ç°¿
    function renderContactBook() {
      const notesDiv = document.getElementById("notes");
      onSnapshot(collection(db, "contactbook"), (snapshot) => {
        notesDiv.innerHTML = "";
        snapshot.forEach((docItem) => {
          const d = docItem.data();
          const isAuthor = d.author === currentUser.email;
          const canEdit = currentRole === "teacher" || currentRole === "admin";
          const replyId = `reply-${docItem.id}`;
          notesDiv.innerHTML += `
            <div class="note">
              <b>${d.author}</b><br>${d.content}<br>
              ${canEdit ? `
                <button onclick="editNote('${docItem.id}', '${d.content}')">ç·¨è¼¯</button>
                <button onclick="deleteNote('${docItem.id}', '${d.content}')">åˆªé™¤</button>
                <button onclick="toggleReply('${replyId}')">å›è¦†</button>
                <div id="${replyId}" style="display:none;">
                  <textarea id="reply-text-${docItem.id}" placeholder="è¼¸å…¥å›è¦†..."></textarea>
                  <button onclick="sendReply('${docItem.id}', '${d.author}')">é€å‡º</button>
                </div>
              ` : ""}
            </div>`;
        });
      });
    }

    // ğŸ”¹ ç·¨è¼¯
    window.editNote = async (id, oldContent) => {
      const newContent = prompt("ä¿®æ”¹å…§å®¹ï¼š", oldContent);
      if (newContent) await updateDoc(doc(db, "contactbook", id), { content: newContent });
    };

    // ğŸ”¹ åˆªé™¤
    window.deleteNote = async (id, content) => {
      if (confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) {
        await deleteDoc(doc(db, "contactbook", id));
        await addDoc(collection(db, "deleted_log"), {
          deletedBy: currentUser.email,
          content,
          time: Date.now()
        });
      }
    };

    // ğŸ”¹ é¡¯ç¤ºåˆªé™¤ç´€éŒ„
    function renderDeletedLogs() {
      const logDiv = document.getElementById("deleted-logs");
      onSnapshot(collection(db, "deleted_log"), (snapshot) => {
        logDiv.innerHTML = "";
        snapshot.forEach((docItem) => {
          const d = docItem.data();
          logDiv.innerHTML += `<div class="log"><b>${d.deletedBy}</b> åˆªé™¤ï¼šã€Œ${d.content}ã€</div>`;
        });
      });
    }

    // ğŸ”¹ å›è¦†ï¼ˆè€å¸«æˆ–ç®¡ç†å“¡ï¼‰
    window.toggleReply = (id) => {
      const el = document.getElementById(id);
      el.style.display = el.style.display === "none" ? "block" : "none";
    };

    window.sendReply = async (noteId, studentEmail) => {
      const text = document.getElementById(`reply-text-${noteId}`).value.trim();
      if (!text) return;
      await addDoc(collection(db, "replies"), {
        to: studentEmail,
        from: currentUser.email,
        text,
        time: Date.now()
      });
      alert("âœ… å·²å›è¦†è©²å­¸ç”Ÿï¼");
    };

    // ğŸ”¹ ä½¿ç”¨è€…æ¬Šé™ç®¡ç†ï¼ˆç®¡ç†å“¡ï¼‰
    function renderUserList() {
      const userList = document.getElementById("user-list");
      onSnapshot(collection(db, "users"), (snapshot) => {
        userList.innerHTML = "";
        snapshot.forEach((docItem) => {
          const u = docItem.data();
          const email = docItem.id;
          userList.innerHTML += `
            <div class="note">
              <b>${email}</b><br>
              ç›®å‰èº«åˆ†ï¼š<b>${u.role}</b><br>
              <select id="role-${email}" onchange="updateUserRole('${email}')">
                <option value="student" ${u.role === "student" ? "selected" : ""}>å­¸ç”Ÿ</option>
                <option value="teacher" ${u.role === "teacher" ? "selected" : ""}>è€å¸«</option>
                <option value="admin" ${u.role === "admin" ? "selected" : ""}>ç®¡ç†å“¡</option>
              </select>
            </div>`;
        });
      });
    }

    window.updateUserRole = async (email) => {
      const select = document.getElementById(`role-${email}`);
      const newRole = select.value;
      await setDoc(doc(db, "users", email), { role: newRole }, { merge: true });
      alert(`âœ… å·²æ›´æ–° ${email} çš„èº«åˆ†ç‚º ${newRole}`);
    };
  </script>

  <style>
    body { font-family: sans-serif; margin: 20px; }
    .note, .log { background: #eee; padding: 10px; border-radius: 8px; margin: 8px 0; }
    textarea { width: 100%; height: 60px; }
  </style>
</head>

<body>
  <div id="login-page">
    <h2>ç™»å…¥ç³»çµ±</h2>
    <button id="login-btn">ä½¿ç”¨ Google ç™»å…¥</button>
  </div>

  <div id="main-page" style="display:none;">
    <div>ğŸ‘¤ ä½¿ç”¨è€…ï¼š<span id="user-info"></span> <button id="logout-btn">ç™»å‡º</button></div>

    <div id="teacher-panel" style="display:none;">
      <h3>ğŸ“˜ è¯çµ¡ç°¿</h3>
      <textarea id="note-input" placeholder="è¼¸å…¥è¯çµ¡ç°¿å…§å®¹..."></textarea>
      <button id="add-btn">æ–°å¢</button>
      <div id="notes"></div>
    </div>

    <div id="admin-panel" style="display:none;">
      <h3>ğŸ—‘ï¸ åˆªé™¤ç´€éŒ„</h3>
      <div id="deleted-logs"></div>
    </div>

    <div id="user-manager" style="display:none;">
      <h3>ğŸ‘‘ ä½¿ç”¨è€…æ¬Šé™ç®¡ç†</h3>
      <div id="user-list"></div>
    </div>
  </div>
</body>
</html>
