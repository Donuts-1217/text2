<div id="chat-box" style="height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px;"></div>
<input id="chat-input" placeholder="輸入訊息..." />
<button id="send-btn">送出</button>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "你的 apiKey",
    authDomain: "你的 authDomain",
    projectId: "你的 projectId",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const chatBox = document.getElementById("chat-box");
  const chatInput = document.getElementById("chat-input");
  const sendBtn = document.getElementById("send-btn");

  // 🔹 監聽訊息變化
  const chatQuery = query(collection(db, "chat"), orderBy("time", "asc"));
  onSnapshot(chatQuery, (snapshot) => {
    chatBox.innerHTML = "";
    snapshot.forEach((doc) => {
      const data = doc.data();
      const msg = document.createElement("div");
      const date = data.time?.toDate().toLocaleString() || "";
      msg.textContent = `[${data.role || "未知"}] ${data.name}: ${data.message} (${date})`;
      chatBox.appendChild(msg);
    });
    chatBox.scrollTop = chatBox.scrollHeight;
  });

  // 🔹 送出訊息
  sendBtn.onclick = async () => {
    const user = auth.currentUser;
    if (!user) return alert("請先登入！");
    const text = chatInput.value.trim();
    if (!text) return;
    await addDoc(collection(db, "chat"), {
      name: user.displayName,
      message: text,
      role: "學生", // 可以根據你的登入權限自動指定
      time: serverTimestamp(), // ✅ 用 Timestamp 儲存
    });
    chatInput.value = "";
  };
</script>
