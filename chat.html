<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, getDocs, setDoc, doc, getDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  // âœ… ä½ çš„ Firebase è¨­å®š
  const firebaseConfig = {
    apiKey: "AIzaSyAPJ_QfW6IurPiSFg1yrcrr3eu2eoLMXqM",
    authDomain: "text-585a6.firebaseapp.com",
    projectId: "text-585a6",
    storageBucket: "text-585a6.firebasestorage.app",
    messagingSenderId: "789195223699",
    appId: "1:789195223699:web:847902083fb646bda25366",
    measurementId: "G-FL11M47EFP"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  // ğŸ”¹ Google ç™»å…¥
  async function googleLogin() {
    try {
      await signInWithPopup(auth, provider);
    } catch (e) {
      console.error(e);
      alert("ç™»å…¥å¤±æ•—ï¼");
    }
  }

  // ğŸ”¹ ç™»å‡º
  async function logout() {
    await signOut(auth);
    location.reload();
  }

  // ğŸ”¹ è€å¸«æˆ–ç®¡ç†å“¡å¯«è¯çµ¡ç°¿
  async function addNote() {
    const content = document.getElementById("note").value.trim();
    if (!content) return alert("è«‹è¼¸å…¥å…§å®¹ï¼");
    await addDoc(collection(db, "notes"), {
      author: auth.currentUser.displayName,
      email: auth.currentUser.email,
      content: content.replace(/\n/g, "<br>"),
      time: new Date().toLocaleString()
    });
    document.getElementById("note").value = "";
    loadNotes();
  }

  // ğŸ”¹ è¼‰å…¥è¯çµ¡ç°¿
  async function loadNotes() {
    const querySnapshot = await getDocs(collection(db, "notes"));
    const messagesEl = document.getElementById("messages");
    messagesEl.innerHTML = "";
    querySnapshot.forEach((doc) => {
      const data = doc.data();
      messagesEl.innerHTML += `
        <div class='note'>
          <b>${data.author}</b><br>
          ${data.content}<br>
          <small>${data.time}</small>
        </div>`;
    });
  }

  // ğŸ”¹ æ–°å¢èŠå¤©å®¤è¨Šæ¯
  async function sendMessage() {
    const input = document.getElementById("chat-input");
    const text = input.value.trim();
    if (!text) return;

    await addDoc(collection(db, "chat"), {
      name: auth.currentUser.displayName,
      email: auth.currentUser.email,
      role: window.userRole,
      message: text,
      time: new Date().toLocaleString()
    });
    input.value = "";
  }

  // ğŸ”¹ é¡¯ç¤ºèŠå¤©å®¤è¨Šæ¯
  function renderChat() {
    const chatBox = document.getElementById("chat-box");
    onSnapshot(collection(db, "chat"), (snapshot) => {
      chatBox.innerHTML = "";
      snapshot.forEach((doc) => {
        const data = doc.data();
        let msgText = data.message
          .replace(/\n/g, "<br>")
          .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');
        chatBox.innerHTML += `
          <div style="margin-bottom:6px;">
            <b>(${data.role}) ${data.name}</b>: ${msgText}
            <br><small>${data.time}</small>
          </div>`;
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    });
  }

  // ğŸ”¹ ç™»å…¥ç›£è½
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      document.getElementById("login-section").style.display = "none";
      document.getElementById("app").style.display = "block";
      document.getElementById("user-info").innerText = `ğŸ‘‹ æ­¡è¿ ${user.displayName}`;

      // é è¨­è§’è‰²
      const userRef = doc(db, "users", user.email);
      const userDoc = await getDoc(userRef);
      let role = "student";
      if (!userDoc.exists()) {
        await setDoc(userRef, { role: user.email === "chianghansen0302@gmail.com" ? "admin" : "student" });
        role = user.email === "chianghansen0302@gmail.com" ? "admin" : "student";
      } else {
        role = userDoc.data().role;
      }
      window.userRole = role;

      // ç®¡ç†å“¡ + è€å¸«å¯ä»¥å¯«è¯çµ¡ç°¿
      if (role === "teacher" || role === "admin") {
        document.getElementById("teacher-panel").style.display = "block";
      }

      loadNotes();
      renderChat();
    }
  });

  // ğŸ”¹ ç¶å®šæŒ‰éˆ•
  window.googleLogin = googleLogin;
  window.logout = logout;
  window.addNote = addNote;
  window.sendMessage = sendMessage;
</script>
